# âœ… ê¸°ëŠ¥ ìš”ì•½
#
# PR ìƒì„± ì‹œ ì´ë©”ì¼ ë°œì†¡
# PR ë³‘í•© ì‹œ ì´ë©”ì¼ ë°œì†¡
# PR ì½”ë“œë¦¬ë·°(ë¼ì¸ ëŒ“ê¸€) ì‹œ ì´ë©”ì¼ ë°œì†¡
# ì´ìŠˆ ìƒì„± ì‹œ ì´ë©”ì¼ ë°œì†¡
# ë¶ˆí•„ìš”í•œ í•­ëª©ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ

# ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ì„ ìœ„í•œ GitHub Actions

name: Email Notifications

on:
  issues:
    types: [opened]  # âœ… ì´ìŠˆ ìƒì„± ì‹œ
  pull_request:
    types: [opened, closed]  # âœ… PR ìƒì„± ë° ë³‘í•© ì‹œ
  issue_comment:
    types: [created]  # âœ… PRì— ë‹¬ë¦° ì¼ë°˜ ëŒ“ê¸€
  pull_request_review_comment:
    types: [created]  # âœ… PR ì½”ë“œ í•œ ì¤„ ì˜†ì— ë‹¬ë¦° ëŒ“ê¸€
  pull_request_review:
    types: [submitted]  # âœ… ì „ì²´ PRì— ëŒ€í•œ ë¦¬ë·° ì œì¶œ (ğŸ’¡ ì§€ê¸ˆ ì¶”ê°€í•œ ë¶€ë¶„)

jobs:
  notify_by_email:
    runs-on: ubuntu-latest

    steps:
      - name: Set Custom Event Name and Build Body
        id: set_event_name
        run: |
          EVENT_LABEL=""
          BODY=""

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
              EVENT_LABEL="PR ë³‘í•©"
            else
              EVENT_LABEL="PR ìƒì„±"
            fi
            TITLE="${{ github.event.pull_request.title }}"
            LINK="${{ github.event.pull_request.html_url }}"

          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ "${{ toJson(github.event.issue.pull_request) }}" != "null" ]]; then
              EVENT_LABEL="PR ëŒ“ê¸€"
              TITLE="${{ github.event.issue.title }}"
              LINK="${{ github.event.comment.html_url }}"
              COMMENT="${{ github.event.comment.body }}"
              FILE="${{ github.event.comment.path }}"
              LINE="${{ github.event.comment.line }}"
            else
              echo "event_label=ë¬´ì‹œë¨" >> $GITHUB_OUTPUT
              echo "body=ì´ìŠˆ ëŒ“ê¸€ì´ë¯€ë¡œ ì•Œë¦¼ ì œì™¸ë¨" >> $GITHUB_OUTPUT
              exit 0
            fi

          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            EVENT_LABEL="PR ì½”ë“œë¦¬ë·° ëŒ“ê¸€"
            TITLE="${{ github.event.pull_request.title }}"
            LINK="${{ github.event.comment.html_url }}"
            COMMENT="${{ github.event.comment.body }}"
            FILE="${{ github.event.comment.path }}"
            LINE="${{ github.event.comment.line }}"

          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            EVENT_LABEL="PR ë¦¬ë·° ì œì¶œ"
            TITLE="${{ github.event.pull_request.title }}"
            LINK="${{ github.event.review.html_url }}"
            COMMENT="${{ github.event.review.body }}"

          elif [[ "${{ github.event_name }}" == "issues" ]]; then
            EVENT_LABEL="ì´ìŠˆ ìƒì„±"
            TITLE="${{ github.event.issue.title }}"
            LINK="${{ github.event.issue.html_url }}"

          else
            echo "event_label=ë¬´ì‹œë¨" >> $GITHUB_OUTPUT
            echo "body=ì§€ì›ë˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸ì…ë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "event_label=$EVENT_LABEL" >> $GITHUB_OUTPUT

          BODY+="ğŸ“Œ ì´ë²¤íŠ¸ ì¢…ë¥˜: $EVENT_LABEL"$'\n'
          BODY+="ğŸ“ ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}"$'\n'
          BODY+="ğŸ› ï¸ ì•¡ì…˜: ${{ github.event.action || 'N/A' }}"$'\n'
          BODY+="ğŸ“ ì œëª©: ${TITLE:-N/A}"$'\n'
          BODY+="ğŸ™‹ ì‘ì„±ì: ${{ github.actor }}"$'\n'
          [[ -n "$LINK" ]] && BODY+="ğŸ”— ë§í¬: $LINK"$'\n'
          [[ -n "$COMMENT" ]] && BODY+="ğŸ—¨ï¸ ëŒ“ê¸€ ë‚´ìš©: $COMMENT"$'\n'
          [[ -n "$FILE" ]] && BODY+="ğŸ“„ íŒŒì¼: $FILE"$'\n'
          [[ -n "$LINE" ]] && BODY+="ğŸ“Œ ìœ„ì¹˜: Line $LINE"$'\n'

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Email Notification
        if: steps.set_event_name.outputs.event_label != 'ë¬´ì‹œë¨'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: GitHub ì•Œë¦¼ - ${{ steps.set_event_name.outputs.event_label }} ë°œìƒ!
          body: ${{ steps.set_event_name.outputs.body }}
          to: indextrown@gmail.com, ghddpgml@gmail.com, youbizone@gmail.com, ijn9907@gmail.com, dongchankim1999@gmail.com
          from: GitHub Notifier <${{ secrets.MAIL_USERNAME }}>
