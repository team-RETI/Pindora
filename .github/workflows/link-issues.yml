name: Add commit comment to issue

on:
  push:
    branches:
      - '**'  # 모든 브랜치에서 작동

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Extract and group commit messages by issue
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits;
            const issuePattern = /#(\d+)/g;

            const issueCommitsMap = {};

            for (const commit of commits) {
              const message = commit.message;
              const matches = [...message.matchAll(issuePattern)];

              for (const match of matches) {
                const issueNumber = match[1];

                if (!issueCommitsMap[issueNumber]) {
                  issueCommitsMap[issueNumber] = [];
                }

                issueCommitsMap[issueNumber].push(message.trim());
              }
            }

            for (const issueNumber in issueCommitsMap) {
              const commitsText = issueCommitsMap[issueNumber]
                .map(msg => `> ${msg}`)
                .join('\n'); // ✅ 진짜 줄바꿈

              const body = [
                '💬 이번 푸시에 포함된 커밋 목록입니다:',
                '',
                commitsText
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
            }
