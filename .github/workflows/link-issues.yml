name: Add commit comment to issue

on:
  push:
    branches:
      - '**'

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Group commits by issue and comment once per issue
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits;
            const issuePattern = /#(\d+)/g;

            // Map<issueNumber, commit[]>
            const issueCommitsMap = {};

            for (const commit of commits) {
              const message = commit.message;
              const matches = [...message.matchAll(issuePattern)];

              for (const match of matches) {
                const issueNumber = match[1];
                if (!issueCommitsMap[issueNumber]) {
                  issueCommitsMap[issueNumber] = [];
                }

                issueCommitsMap[issueNumber].push({
                  sha: commit.id.substring(0, 7),
                  url: commit.url,
                  message
                });
              }
            }

            // ì´ìŠˆë³„ë¡œ í•œ ë²ˆë§Œ ëŒ“ê¸€ ìž‘ì„±
            for (const issueNumber in issueCommitsMap) {
              const commitsText = issueCommitsMap[issueNumber]
                .map(commit => `- [\`${commit.sha}\`](${commit.url}): ${commit.message}`)
                .join('\n');

              const body = `ðŸ“¦ ì´ë²ˆ í‘¸ì‹œì— í¬í•¨ëœ ì»¤ë°‹ ëª©ë¡ìž…ë‹ˆë‹¤:\n\n${commitsText}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
            }


#name: Add commit comment to issue
#
#on:
#  push:
#    branches:
#      - '**'  # ëª¨ë“  ë¸Œëžœì¹˜ì—ì„œ ìž‘ë™
##      - main
##      - develop
#
#jobs:
#  comment:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Extract commit messages
#        uses: actions/github-script@v7
#        with:
#          script: |
#            const commits = context.payload.commits;
#            const issuePattern = /#(\d+)/g;
#
#            for (const commit of commits) {
#              const message = commit.message;
#              const matches = [...message.matchAll(issuePattern)];
#              for (const match of matches) {
#                const issueNumber = match[1];
#                const commentBody = `ðŸ’¬ ì»¤ë°‹ [\`${commit.id.substring(0, 7)}\`](${commit.url}) ê°€ ì´ìŠˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n> ${message}`;
#                
#                await github.rest.issues.createComment({
#                  owner: context.repo.owner,
#                  repo: context.repo.repo,
#                  issue_number: issueNumber,
#                  body: commentBody
#                });
#              }
#            }
